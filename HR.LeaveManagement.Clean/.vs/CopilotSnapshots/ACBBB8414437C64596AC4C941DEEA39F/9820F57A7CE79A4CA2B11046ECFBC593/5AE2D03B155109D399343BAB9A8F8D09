using AutoMapper;
using HR.LeaveManagement.Application.Contracts.Logging;
using HR.LeaveManagement.Application.Contracts.Persistence;
using HR.LeaveManagement.Application.Features.LeaveType.Queries.GetAllLeaveTypes;
using HR.LeaveManagement.Application.MappingProfiles;
using HR.LeaveManagement.Application.UnitTests.Mocks;
using HR.LeaveManagement.Domain;
using Moq;
using Shouldly;

namespace HR.LeaveManagement.Application.UnitTests.Features.LeaveTypes.Queries
{
    public class GetLeaveTypesQueryHandlerTests
    {
        private readonly Mock<ILeaveTypeRepository> _mockRepo;
        private Mock<IMapper> _mockMapper;
        private Mock<IAppLogger<GetLeaveTypesQueryHandler>> _mockAppLogger;

        public GetLeaveTypesQueryHandlerTests()
        {
            _mockRepo = MockLeaveTypeRepository.GetLeaeveTypeMockLeaveTypeRepository();
            _mockMapper = new Mock<IMapper>();
            _mockAppLogger = new Mock<IAppLogger<GetLeaveTypesQueryHandler>>();

            // Setup the mapper mock to return mapped DTOs
            _mockMapper.Setup(m => m.Map<List<LeaveTypeDto>>(It.IsAny<IReadOnlyList<LeaveType>>()))
                .Returns((IReadOnlyList<LeaveType> source) => source.Select(lt => new LeaveTypeDto
                {
                    Id = lt.Id,
                    Name = lt.Name,
                    DefaultDays = lt.DefaultDays
                }).ToList());
        }

        [Fact]
        public async Task GetLeaveTypesListTest()
        {
            var handler = new GetLeaveTypesQueryHandler(_mockMapper.Object, _mockRepo.Object, _mockAppLogger.Object);
            var result = await handler.Handle(new GetLeaveTypesQuery(), CancellationToken.None);

            result.ShouldBeOfType<List<LeaveTypeDto>>();
            result.Count.ShouldBe(3);
        }

        [Fact]
        public async Task GetLeaveTypesList_ShouldReturnCorrectData()
        {
            var handler = new GetLeaveTypesQueryHandler(_mockMapper.Object, _mockRepo.Object, _mockAppLogger.Object);
            var result = await handler.Handle(new GetLeaveTypesQuery(), CancellationToken.None);

            result.ShouldNotBeNull();
            result.Count.ShouldBe(3);
            result.ShouldContain(x => x.Name == "Test Vacation" && x.DefaultDays == 10);
            result.ShouldContain(x => x.Name == "Test Sick" && x.DefaultDays == 12);
            result.ShouldContain(x => x.Name == "Test Unpaid" && x.DefaultDays == 20);
        }
    }
}
